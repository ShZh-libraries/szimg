# 一. netpbm简介

如果要表示一张图片，最少要多少的信息？——答案是两种：图像的**像素数组**和它的**各个维度**信息（就是宽高）。

在实际的编码过程中，可能只需要一个参数。这是因为**定长数组本身就包含维度信息**。

netpbm就是这样一种图像格式，除了宽高，数组之外。基本上就没有其他信息了。

它可能是我见过的最简单的图像格式了。



# 二. netpbm的两种模式

netpbm一共有两种模式——文本模式和二进制模式。

这两种模式**作用于图像的有效载荷**上（即，图像的模式，**对魔数和宽高等头部信息不起作用**）。

在文本模式下，每一个像素值是用一个整型来表示的。而二进制模式下则是把整形转化成了字节来表示。

比如灰度图中，某一个像素的值为128，这个在文本模式下要通过'1', '2', '8'三个字符来表示；但是在二进制模式下只要一个0x80即可。

直观地感受一下文本模式的易读性：

```
P1
# This is an example bitmap of the letter "J"
6 10
0 0 0 0 1 0
0 0 0 0 1 0
0 0 0 0 1 0
0 0 0 0 1 0
0 0 0 0 1 0
0 0 0 0 1 0
1 0 0 0 1 0
0 1 1 1 0 0
0 0 0 0 0 0
0 0 0 0 0 0
```

虽然文本模式显示一个图像非常奇怪，但是这种图像格式还是**被主流的操作系统平台所支持**。



# 三. netpbm家族

### 1. portable bitmap format

组成：

- Magic number: 文本模式下为P1，二进制模式下为P4.
- 宽高（基本上图像的格式**都是宽在前**）
- 有效载荷

上面的例子中就是pbm在文本模式下的例子，每一个像素要么是0要么是1，用空格分隔。

二进制模式下就很有意思了，所有教科书上都说一个像素占的是一个bit，实际上一个像素的值所占的要>=1 bit。

考虑bit总数不为8的倍数的情况，比如一个图有9个像素。换算下来就是一个字节又一个比特，但是计算机寻址的最小单位是字节，你怎么能找到最后一个像素呢？所以要进行补全。

但是这种补全，又不是普通人想象中的补全。比如一个图有60个像素。它有效载荷所占的空间，就是60除以8向上取整，为8字节吗？

非也，这种补全是按行来计算的。假设这60个像素是5x12，那么每一行就占12除以8向上取整，为2个字节，总共10个字节。

另外，**第一个bit在整个字节中的最高位**。

### 2. portable graymap format

组成：

- magic number：文本模式下为P2，二进制模式下为P5
- 宽高
- 灰度的最大值
- 有效载荷

这里有意思的一点就是灰度的最大值。因为一般情况下我们眼中的灰度图，范围都是0～255，没想到灰度图的最大值竟然可以自己设置。理由会在下面讲ppm讲。

感受一下文本模式下灰度图的直观：

```
P2
# Shows the word "FEEP" (example from Netpbm man page on PGM)
24 7
15
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
0  3  3  3  3  0  0  7  7  7  7  0  0 11 11 11 11  0  0 15 15 15 15  0
0  3  0  0  0  0  0  7  0  0  0  0  0 11  0  0  0  0  0 15  0  0 15  0
0  3  3  3  0  0  0  7  7  7  0  0  0 11 11 11  0  0  0 15 15 15 15  0
0  3  0  0  0  0  0  7  0  0  0  0  0 11  0  0  0  0  0 15  0  0  0  0
0  3  0  0  0  0  0  7  7  7  7  0  0 11 11 11 11  0  0 15  0  0  0  0
0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
```

### 3. portable pixelmap format

组成：

- magic number: 文本模式下为P3，二进制模式下为P6
- 宽高
- 每个channel的最大值
- 有效载荷

ppm的文本模式基本上没有用，因为它一点也不直观，以前都是一个整形代表一个像素，你不眼瞎就能看出来图像的大致样子。但是在ppm下，你一个像素就有三个整形，这谁看得出来。

至于最大值，一个合理的解释是：如果你只想用纯色，这里指的是每个通道的值不是0就是255，那么255这个值就没有任何意义。这种情况下你完全可以把最大值设为1，这样你的有效载荷也是由0和1组成，当然他也是彩色的。

ppm的一个缺点是他**没有压缩**，它的体积差不多就是宽 x 高 x 通道。因此它**不适合在网络上传输**，但是它可以**作为一种中间格式**来使用。

### 4. netpbm的16bit和32bit扩展

就是指灰度图的最大值可以用16bit（原来是8bit）存储。

RGB彩色图的最大值可以用32bit（原来是24bit）存储。

但是这两种扩展，会有大小端等问题，用的人也不多，所以就不写了。



# 四. PAM

PAM是netpbm的另一种扩展，他可以**同时支持黑白，灰度，RGB彩色以及上述三种图像的不透明度版本**。

这种格式的有效载荷同PPM是一样的（除了它没有Ascii模式，只有Binary模式外），因此这里重点介绍头部的差异：

组成：

- magic number：固定P7，注意因为**没有Ascii模式**，所以只有这一个magic number。黑白图中每一个像素，**在PAM中都占一个byte**，请注意。
- WIDTH和HEIGHT：原本是两个整形来表示，**PAM中使用了键值对的形式（见下）**。同时PAM中每一行都有换行符，而不是之前的空白符。
- DEPTH：代表有几个通道。比如黑白和灰度的深度就是1，RGB彩色就是3。如果带了alpha通道就再加一。你可以认为这个代表了**图像的第三维信息**。
- MAXVALUE：代表每一个像素值的最大值，之前的格式中已经讲过了。你可以认为这个代表了**图像中每一个元素的信息**。注意和DEPTH相区别。
- TUPLETYPE：代表了图像所属的类型，见下表。
- ENDHDR：显示地说明头部已经结束了。

先给出头部信息给大伙瞧一瞧，看看键值对头部是如何实现的：

```
P7
WIDTH 4
HEIGHT 2
DEPTH 4
MAXVAL 255
TUPLTYPE RGB_ALPHA
ENDHDR
```

然后再来看下各种TUPLETYPE的类型：

| TUPLTYPE            | MAXVAL    | DEPTH | comment                            |
| ------------------- | --------- | ----- | ---------------------------------- |
| BLACKANDWHITE       | 1         | 1     | special case of GRAYSCALE          |
| GRAYSCALE           | 2...65535 | 1     | 2 bytes per pixel for MAXVAL > 255 |
| RGB                 | 1...65535 | 3     | 6 bytes per pixel for MAXVAL > 255 |
| BLACKANDWHITE_ALPHA | 1         | 2     | 2 bytes per pixel                  |
| GRAYSCALE_ALPHA     | 2...65535 | 2     | 4 bytes per pixel for MAXVAL > 255 |
| RGB_ALPHA           | 1...65535 | 4     | 8 bytes per pixel for MAXVAL > 255 |

注意作者的电脑（MacOS BigSur 11.3）并不支持PAM格式的图片，所以这里就不详细展开了。